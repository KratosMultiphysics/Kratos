#include "custom_elements/stokes_3D_weakly_compressible.h"

namespace Kratos {


void Stokes3DWeaklyCompressible::ComputeGaussPointLHSContribution(bounded_matrix<double,16,16>& lhs, const element_data<4,3>& data)
    {
        const int nnodes = 4;
        const int dim = 3;
        
        const double& bdf0 = data.bdf0;
//         const double& bdf1 = data.bdf1;
//         const double& bdf2 = data.bdf2;
        
        const auto& v = data.v;
//         const auto& vn = data.vn;
//         const auto& vnn = data.vnn;
        
//         const auto& p = data.p;
//         const auto& pn = data.pn;
//         const auto& pnn = data.pnn;
        
         const auto& r = data.r;
//         const auto& rn = data.rn;
//         const auto& rnn = data.rnn;   
        
        const double rho_gauss = inner_prod(data.N, data.r);
         
        const double k = data.k;
        
        //get constitutive matrix 
        const Matrix& C = data.C;
        
        //get shape function values
        const bounded_matrix<double,nnodes,dim>& DN = data.DN_DX;
        const array_1d<double,nnodes>& N = data.N;
        
        
        //compute an equivalent tau by Bitrans*c*Bi
        const double tau_denom =             (C(3,3) + C(4,4) + C(5,5))*(pow(DN(0,0), 2) + pow(DN(0,1), 2) + pow(DN(0,2), 2) + pow(DN(1,0), 2) + pow(DN(1,1), 2) + pow(DN(1,2), 2) + pow(DN(2,0), 2) + pow(DN(2,1), 2) + pow(DN(2,2), 2) + pow(DN(3,0), 2) + pow(DN(3,1), 2) + pow(DN(3,2), 2));

        const double tau1 = 1.0/(tau_denom*rho_gauss);
//         const double tau2 = (C(3,3) + C(4,4) + C(5,5))/(6.0*rho_gauss);
        
        const double clhs0 =             C(0,0)*DN(0,0) + C(0,3)*DN(0,1) + C(0,5)*DN(0,2);
const double clhs1 =             C(0,3)*DN(0,0);
const double clhs2 =             C(3,3)*DN(0,1) + C(3,5)*DN(0,2) + clhs1;
const double clhs3 =             C(0,5)*DN(0,0);
const double clhs4 =             C(3,5)*DN(0,1) + C(5,5)*DN(0,2) + clhs3;
const double clhs5 =             C(0,1)*DN(0,1) + C(0,4)*DN(0,2) + clhs1;
const double clhs6 =             C(1,3)*DN(0,1);
const double clhs7 =             C(3,3)*DN(0,0) + C(3,4)*DN(0,2) + clhs6;
const double clhs8 =             C(3,5)*DN(0,0);
const double clhs9 =             C(4,5)*DN(0,2);
const double clhs10 =             C(1,5)*DN(0,1) + clhs8 + clhs9;
const double clhs11 =             C(0,2)*DN(0,2) + C(0,4)*DN(0,1) + clhs3;
const double clhs12 =             C(3,4)*DN(0,1);
const double clhs13 =             C(2,3)*DN(0,2) + clhs12 + clhs8;
const double clhs14 =             C(2,5)*DN(0,2);
const double clhs15 =             C(4,5)*DN(0,1) + C(5,5)*DN(0,0) + clhs14;
const double clhs16 =             DN(0,0)*N[0];
const double clhs17 =             C(0,0)*DN(1,0) + C(0,3)*DN(1,1) + C(0,5)*DN(1,2);
const double clhs18 =             C(0,3)*DN(1,0);
const double clhs19 =             C(3,3)*DN(1,1) + C(3,5)*DN(1,2) + clhs18;
const double clhs20 =             C(0,5)*DN(1,0);
const double clhs21 =             C(3,5)*DN(1,1) + C(5,5)*DN(1,2) + clhs20;
const double clhs22 =             C(0,1)*DN(1,1) + C(0,4)*DN(1,2) + clhs18;
const double clhs23 =             C(1,3)*DN(1,1);
const double clhs24 =             C(3,3)*DN(1,0) + C(3,4)*DN(1,2) + clhs23;
const double clhs25 =             C(3,5)*DN(1,0);
const double clhs26 =             C(4,5)*DN(1,2);
const double clhs27 =             C(1,5)*DN(1,1) + clhs25 + clhs26;
const double clhs28 =             C(0,2)*DN(1,2) + C(0,4)*DN(1,1) + clhs20;
const double clhs29 =             C(3,4)*DN(1,1);
const double clhs30 =             C(2,3)*DN(1,2) + clhs25 + clhs29;
const double clhs31 =             C(2,5)*DN(1,2);
const double clhs32 =             C(4,5)*DN(1,1) + C(5,5)*DN(1,0) + clhs31;
const double clhs33 =             DN(0,0)*N[1];
const double clhs34 =             C(0,0)*DN(2,0) + C(0,3)*DN(2,1) + C(0,5)*DN(2,2);
const double clhs35 =             C(0,3)*DN(2,0);
const double clhs36 =             C(3,3)*DN(2,1) + C(3,5)*DN(2,2) + clhs35;
const double clhs37 =             C(0,5)*DN(2,0);
const double clhs38 =             C(3,5)*DN(2,1) + C(5,5)*DN(2,2) + clhs37;
const double clhs39 =             C(0,1)*DN(2,1) + C(0,4)*DN(2,2) + clhs35;
const double clhs40 =             C(1,3)*DN(2,1);
const double clhs41 =             C(3,3)*DN(2,0) + C(3,4)*DN(2,2) + clhs40;
const double clhs42 =             C(3,5)*DN(2,0);
const double clhs43 =             C(4,5)*DN(2,2);
const double clhs44 =             C(1,5)*DN(2,1) + clhs42 + clhs43;
const double clhs45 =             C(0,2)*DN(2,2) + C(0,4)*DN(2,1) + clhs37;
const double clhs46 =             C(3,4)*DN(2,1);
const double clhs47 =             C(2,3)*DN(2,2) + clhs42 + clhs46;
const double clhs48 =             C(2,5)*DN(2,2);
const double clhs49 =             C(4,5)*DN(2,1) + C(5,5)*DN(2,0) + clhs48;
const double clhs50 =             DN(0,0)*N[2];
const double clhs51 =             C(0,0)*DN(3,0) + C(0,3)*DN(3,1) + C(0,5)*DN(3,2);
const double clhs52 =             C(0,3)*DN(3,0);
const double clhs53 =             C(3,3)*DN(3,1) + C(3,5)*DN(3,2) + clhs52;
const double clhs54 =             C(0,5)*DN(3,0);
const double clhs55 =             C(3,5)*DN(3,1) + C(5,5)*DN(3,2) + clhs54;
const double clhs56 =             C(0,1)*DN(3,1) + C(0,4)*DN(3,2) + clhs52;
const double clhs57 =             C(1,3)*DN(3,1);
const double clhs58 =             C(3,3)*DN(3,0) + C(3,4)*DN(3,2) + clhs57;
const double clhs59 =             C(3,5)*DN(3,0);
const double clhs60 =             C(4,5)*DN(3,2);
const double clhs61 =             C(1,5)*DN(3,1) + clhs59 + clhs60;
const double clhs62 =             C(0,2)*DN(3,2) + C(0,4)*DN(3,1) + clhs54;
const double clhs63 =             C(3,4)*DN(3,1);
const double clhs64 =             C(2,3)*DN(3,2) + clhs59 + clhs63;
const double clhs65 =             C(2,5)*DN(3,2);
const double clhs66 =             C(4,5)*DN(3,1) + C(5,5)*DN(3,0) + clhs65;
const double clhs67 =             DN(0,0)*N[3];
const double clhs68 =             C(0,1)*DN(0,0) + C(1,5)*DN(0,2) + clhs6;
const double clhs69 =             C(0,4)*DN(0,0) + clhs12 + clhs9;
const double clhs70 =             C(1,1)*DN(0,1) + C(1,3)*DN(0,0) + C(1,4)*DN(0,2);
const double clhs71 =             C(1,4)*DN(0,1);
const double clhs72 =             C(3,4)*DN(0,0) + C(4,4)*DN(0,2) + clhs71;
const double clhs73 =             C(1,2)*DN(0,2) + C(1,5)*DN(0,0) + clhs71;
const double clhs74 =             C(2,4)*DN(0,2);
const double clhs75 =             C(4,4)*DN(0,1) + C(4,5)*DN(0,0) + clhs74;
const double clhs76 =             DN(0,1)*N[0];
const double clhs77 =             C(0,1)*DN(1,0) + C(1,5)*DN(1,2) + clhs23;
const double clhs78 =             C(0,4)*DN(1,0) + clhs26 + clhs29;
const double clhs79 =             C(1,1)*DN(1,1) + C(1,3)*DN(1,0) + C(1,4)*DN(1,2);
const double clhs80 =             C(1,4)*DN(1,1);
const double clhs81 =             C(3,4)*DN(1,0) + C(4,4)*DN(1,2) + clhs80;
const double clhs82 =             C(1,2)*DN(1,2) + C(1,5)*DN(1,0) + clhs80;
const double clhs83 =             C(2,4)*DN(1,2);
const double clhs84 =             C(4,4)*DN(1,1) + C(4,5)*DN(1,0) + clhs83;
const double clhs85 =             DN(0,1)*N[1];
const double clhs86 =             C(0,1)*DN(2,0) + C(1,5)*DN(2,2) + clhs40;
const double clhs87 =             C(0,4)*DN(2,0) + clhs43 + clhs46;
const double clhs88 =             C(1,1)*DN(2,1) + C(1,3)*DN(2,0) + C(1,4)*DN(2,2);
const double clhs89 =             C(1,4)*DN(2,1);
const double clhs90 =             C(3,4)*DN(2,0) + C(4,4)*DN(2,2) + clhs89;
const double clhs91 =             C(1,2)*DN(2,2) + C(1,5)*DN(2,0) + clhs89;
const double clhs92 =             C(2,4)*DN(2,2);
const double clhs93 =             C(4,4)*DN(2,1) + C(4,5)*DN(2,0) + clhs92;
const double clhs94 =             DN(0,1)*N[2];
const double clhs95 =             C(0,1)*DN(3,0) + C(1,5)*DN(3,2) + clhs57;
const double clhs96 =             C(0,4)*DN(3,0) + clhs60 + clhs63;
const double clhs97 =             C(1,1)*DN(3,1) + C(1,3)*DN(3,0) + C(1,4)*DN(3,2);
const double clhs98 =             C(1,4)*DN(3,1);
const double clhs99 =             C(3,4)*DN(3,0) + C(4,4)*DN(3,2) + clhs98;
const double clhs100 =             C(1,2)*DN(3,2) + C(1,5)*DN(3,0) + clhs98;
const double clhs101 =             C(2,4)*DN(3,2);
const double clhs102 =             C(4,4)*DN(3,1) + C(4,5)*DN(3,0) + clhs101;
const double clhs103 =             DN(0,1)*N[3];
const double clhs104 =             C(0,2)*DN(0,0) + C(2,3)*DN(0,1) + clhs14;
const double clhs105 =             C(1,2)*DN(0,1) + C(2,3)*DN(0,0) + clhs74;
const double clhs106 =             C(2,2)*DN(0,2) + C(2,4)*DN(0,1) + C(2,5)*DN(0,0);
const double clhs107 =             DN(0,2)*N[0];
const double clhs108 =             C(0,2)*DN(1,0) + C(2,3)*DN(1,1) + clhs31;
const double clhs109 =             C(1,2)*DN(1,1) + C(2,3)*DN(1,0) + clhs83;
const double clhs110 =             C(2,2)*DN(1,2) + C(2,4)*DN(1,1) + C(2,5)*DN(1,0);
const double clhs111 =             DN(0,2)*N[1];
const double clhs112 =             C(0,2)*DN(2,0) + C(2,3)*DN(2,1) + clhs48;
const double clhs113 =             C(1,2)*DN(2,1) + C(2,3)*DN(2,0) + clhs92;
const double clhs114 =             C(2,2)*DN(2,2) + C(2,4)*DN(2,1) + C(2,5)*DN(2,0);
const double clhs115 =             DN(0,2)*N[2];
const double clhs116 =             C(0,2)*DN(3,0) + C(2,3)*DN(3,1) + clhs65;
const double clhs117 =             C(1,2)*DN(3,1) + C(2,3)*DN(3,0) + clhs101;
const double clhs118 =             C(2,2)*DN(3,2) + C(2,4)*DN(3,1) + C(2,5)*DN(3,0);
const double clhs119 =             DN(0,2)*N[3];
const double clhs120 =             bdf0*tau1;
const double clhs121 =             clhs120 + k;
const double clhs122 =             clhs121*r[0];
const double clhs123 =             DN(1,0)*N[0];
const double clhs124 =             DN(1,1)*N[0];
const double clhs125 =             DN(1,2)*N[0];
const double clhs126 =             tau1*(DN(0,0)*DN(1,0) + DN(0,1)*DN(1,1) + DN(0,2)*DN(1,2));
const double clhs127 =             DN(2,0)*N[0];
const double clhs128 =             DN(2,1)*N[0];
const double clhs129 =             DN(2,2)*N[0];
const double clhs130 =             tau1*(DN(0,0)*DN(2,0) + DN(0,1)*DN(2,1) + DN(0,2)*DN(2,2));
const double clhs131 =             DN(3,0)*N[0];
const double clhs132 =             DN(3,1)*N[0];
const double clhs133 =             DN(3,2)*N[0];
const double clhs134 =             tau1*(DN(0,0)*DN(3,0) + DN(0,1)*DN(3,1) + DN(0,2)*DN(3,2));
const double clhs135 =             DN(1,0)*N[1];
const double clhs136 =             DN(1,0)*N[2];
const double clhs137 =             DN(1,0)*N[3];
const double clhs138 =             DN(1,1)*N[1];
const double clhs139 =             DN(1,1)*N[2];
const double clhs140 =             DN(1,1)*N[3];
const double clhs141 =             DN(1,2)*N[1];
const double clhs142 =             DN(1,2)*N[2];
const double clhs143 =             DN(1,2)*N[3];
const double clhs144 =             clhs121*r[1];
const double clhs145 =             DN(2,0)*N[1];
const double clhs146 =             DN(2,1)*N[1];
const double clhs147 =             DN(2,2)*N[1];
const double clhs148 =             tau1*(DN(1,0)*DN(2,0) + DN(1,1)*DN(2,1) + DN(1,2)*DN(2,2));
const double clhs149 =             DN(3,0)*N[1];
const double clhs150 =             DN(3,1)*N[1];
const double clhs151 =             DN(3,2)*N[1];
const double clhs152 =             tau1*(DN(1,0)*DN(3,0) + DN(1,1)*DN(3,1) + DN(1,2)*DN(3,2));
const double clhs153 =             DN(2,0)*N[2];
const double clhs154 =             DN(2,0)*N[3];
const double clhs155 =             DN(2,1)*N[2];
const double clhs156 =             DN(2,1)*N[3];
const double clhs157 =             DN(2,2)*N[2];
const double clhs158 =             DN(2,2)*N[3];
const double clhs159 =             clhs121*r[2];
const double clhs160 =             DN(3,0)*N[2];
const double clhs161 =             DN(3,1)*N[2];
const double clhs162 =             DN(3,2)*N[2];
const double clhs163 =             tau1*(DN(2,0)*DN(3,0) + DN(2,1)*DN(3,1) + DN(2,2)*DN(3,2));
const double clhs164 =             DN(3,0)*N[3];
const double clhs165 =             DN(3,1)*N[3];
const double clhs166 =             DN(3,2)*N[3];
const double clhs167 =             clhs121*r[3];
            lhs(0,0)=DN(0,0)*clhs0 + DN(0,1)*clhs2 + DN(0,2)*clhs4;
            lhs(0,1)=DN(0,0)*clhs5 + DN(0,1)*clhs7 + DN(0,2)*clhs10;
            lhs(0,2)=DN(0,0)*clhs11 + DN(0,1)*clhs13 + DN(0,2)*clhs15;
            lhs(0,3)=-clhs16;
            lhs(0,4)=DN(0,0)*clhs17 + DN(0,1)*clhs19 + DN(0,2)*clhs21;
            lhs(0,5)=DN(0,0)*clhs22 + DN(0,1)*clhs24 + DN(0,2)*clhs27;
            lhs(0,6)=DN(0,0)*clhs28 + DN(0,1)*clhs30 + DN(0,2)*clhs32;
            lhs(0,7)=-clhs33;
            lhs(0,8)=DN(0,0)*clhs34 + DN(0,1)*clhs36 + DN(0,2)*clhs38;
            lhs(0,9)=DN(0,0)*clhs39 + DN(0,1)*clhs41 + DN(0,2)*clhs44;
            lhs(0,10)=DN(0,0)*clhs45 + DN(0,1)*clhs47 + DN(0,2)*clhs49;
            lhs(0,11)=-clhs50;
            lhs(0,12)=DN(0,0)*clhs51 + DN(0,1)*clhs53 + DN(0,2)*clhs55;
            lhs(0,13)=DN(0,0)*clhs56 + DN(0,1)*clhs58 + DN(0,2)*clhs61;
            lhs(0,14)=DN(0,0)*clhs62 + DN(0,1)*clhs64 + DN(0,2)*clhs66;
            lhs(0,15)=-clhs67;
            lhs(1,0)=DN(0,0)*clhs2 + DN(0,1)*clhs68 + DN(0,2)*clhs69;
            lhs(1,1)=DN(0,0)*clhs7 + DN(0,1)*clhs70 + DN(0,2)*clhs72;
            lhs(1,2)=DN(0,0)*clhs13 + DN(0,1)*clhs73 + DN(0,2)*clhs75;
            lhs(1,3)=-clhs76;
            lhs(1,4)=DN(0,0)*clhs19 + DN(0,1)*clhs77 + DN(0,2)*clhs78;
            lhs(1,5)=DN(0,0)*clhs24 + DN(0,1)*clhs79 + DN(0,2)*clhs81;
            lhs(1,6)=DN(0,0)*clhs30 + DN(0,1)*clhs82 + DN(0,2)*clhs84;
            lhs(1,7)=-clhs85;
            lhs(1,8)=DN(0,0)*clhs36 + DN(0,1)*clhs86 + DN(0,2)*clhs87;
            lhs(1,9)=DN(0,0)*clhs41 + DN(0,1)*clhs88 + DN(0,2)*clhs90;
            lhs(1,10)=DN(0,0)*clhs47 + DN(0,1)*clhs91 + DN(0,2)*clhs93;
            lhs(1,11)=-clhs94;
            lhs(1,12)=DN(0,0)*clhs53 + DN(0,1)*clhs95 + DN(0,2)*clhs96;
            lhs(1,13)=DN(0,0)*clhs58 + DN(0,1)*clhs97 + DN(0,2)*clhs99;
            lhs(1,14)=DN(0,0)*clhs64 + DN(0,1)*clhs100 + DN(0,2)*clhs102;
            lhs(1,15)=-clhs103;
            lhs(2,0)=DN(0,0)*clhs4 + DN(0,1)*clhs69 + DN(0,2)*clhs104;
            lhs(2,1)=DN(0,0)*clhs10 + DN(0,1)*clhs72 + DN(0,2)*clhs105;
            lhs(2,2)=DN(0,0)*clhs15 + DN(0,1)*clhs75 + DN(0,2)*clhs106;
            lhs(2,3)=-clhs107;
            lhs(2,4)=DN(0,0)*clhs21 + DN(0,1)*clhs78 + DN(0,2)*clhs108;
            lhs(2,5)=DN(0,0)*clhs27 + DN(0,1)*clhs81 + DN(0,2)*clhs109;
            lhs(2,6)=DN(0,0)*clhs32 + DN(0,1)*clhs84 + DN(0,2)*clhs110;
            lhs(2,7)=-clhs111;
            lhs(2,8)=DN(0,0)*clhs38 + DN(0,1)*clhs87 + DN(0,2)*clhs112;
            lhs(2,9)=DN(0,0)*clhs44 + DN(0,1)*clhs90 + DN(0,2)*clhs113;
            lhs(2,10)=DN(0,0)*clhs49 + DN(0,1)*clhs93 + DN(0,2)*clhs114;
            lhs(2,11)=-clhs115;
            lhs(2,12)=DN(0,0)*clhs55 + DN(0,1)*clhs96 + DN(0,2)*clhs116;
            lhs(2,13)=DN(0,0)*clhs61 + DN(0,1)*clhs99 + DN(0,2)*clhs117;
            lhs(2,14)=DN(0,0)*clhs66 + DN(0,1)*clhs102 + DN(0,2)*clhs118;
            lhs(2,15)=-clhs119;
            lhs(3,0)=clhs122*clhs16;
            lhs(3,1)=clhs122*clhs76;
            lhs(3,2)=clhs107*clhs122;
            lhs(3,3)=tau1*(pow(DN(0,0), 2) + pow(DN(0,1), 2) + pow(DN(0,2), 2));
            lhs(3,4)=r[1]*(clhs120*clhs33 + clhs123*k);
            lhs(3,5)=r[1]*(clhs120*clhs85 + clhs124*k);
            lhs(3,6)=r[1]*(clhs111*clhs120 + clhs125*k);
            lhs(3,7)=clhs126;
            lhs(3,8)=r[2]*(clhs120*clhs50 + clhs127*k);
            lhs(3,9)=r[2]*(clhs120*clhs94 + clhs128*k);
            lhs(3,10)=r[2]*(clhs115*clhs120 + clhs129*k);
            lhs(3,11)=clhs130;
            lhs(3,12)=r[3]*(clhs120*clhs67 + clhs131*k);
            lhs(3,13)=r[3]*(clhs103*clhs120 + clhs132*k);
            lhs(3,14)=r[3]*(clhs119*clhs120 + clhs133*k);
            lhs(3,15)=clhs134;
            lhs(4,0)=DN(1,0)*clhs0 + DN(1,1)*clhs2 + DN(1,2)*clhs4;
            lhs(4,1)=DN(1,0)*clhs5 + DN(1,1)*clhs7 + DN(1,2)*clhs10;
            lhs(4,2)=DN(1,0)*clhs11 + DN(1,1)*clhs13 + DN(1,2)*clhs15;
            lhs(4,3)=-clhs123;
            lhs(4,4)=DN(1,0)*clhs17 + DN(1,1)*clhs19 + DN(1,2)*clhs21;
            lhs(4,5)=DN(1,0)*clhs22 + DN(1,1)*clhs24 + DN(1,2)*clhs27;
            lhs(4,6)=DN(1,0)*clhs28 + DN(1,1)*clhs30 + DN(1,2)*clhs32;
            lhs(4,7)=-clhs135;
            lhs(4,8)=DN(1,0)*clhs34 + DN(1,1)*clhs36 + DN(1,2)*clhs38;
            lhs(4,9)=DN(1,0)*clhs39 + DN(1,1)*clhs41 + DN(1,2)*clhs44;
            lhs(4,10)=DN(1,0)*clhs45 + DN(1,1)*clhs47 + DN(1,2)*clhs49;
            lhs(4,11)=-clhs136;
            lhs(4,12)=DN(1,0)*clhs51 + DN(1,1)*clhs53 + DN(1,2)*clhs55;
            lhs(4,13)=DN(1,0)*clhs56 + DN(1,1)*clhs58 + DN(1,2)*clhs61;
            lhs(4,14)=DN(1,0)*clhs62 + DN(1,1)*clhs64 + DN(1,2)*clhs66;
            lhs(4,15)=-clhs137;
            lhs(5,0)=DN(1,0)*clhs2 + DN(1,1)*clhs68 + DN(1,2)*clhs69;
            lhs(5,1)=DN(1,0)*clhs7 + DN(1,1)*clhs70 + DN(1,2)*clhs72;
            lhs(5,2)=DN(1,0)*clhs13 + DN(1,1)*clhs73 + DN(1,2)*clhs75;
            lhs(5,3)=-clhs124;
            lhs(5,4)=DN(1,0)*clhs19 + DN(1,1)*clhs77 + DN(1,2)*clhs78;
            lhs(5,5)=DN(1,0)*clhs24 + DN(1,1)*clhs79 + DN(1,2)*clhs81;
            lhs(5,6)=DN(1,0)*clhs30 + DN(1,1)*clhs82 + DN(1,2)*clhs84;
            lhs(5,7)=-clhs138;
            lhs(5,8)=DN(1,0)*clhs36 + DN(1,1)*clhs86 + DN(1,2)*clhs87;
            lhs(5,9)=DN(1,0)*clhs41 + DN(1,1)*clhs88 + DN(1,2)*clhs90;
            lhs(5,10)=DN(1,0)*clhs47 + DN(1,1)*clhs91 + DN(1,2)*clhs93;
            lhs(5,11)=-clhs139;
            lhs(5,12)=DN(1,0)*clhs53 + DN(1,1)*clhs95 + DN(1,2)*clhs96;
            lhs(5,13)=DN(1,0)*clhs58 + DN(1,1)*clhs97 + DN(1,2)*clhs99;
            lhs(5,14)=DN(1,0)*clhs64 + DN(1,1)*clhs100 + DN(1,2)*clhs102;
            lhs(5,15)=-clhs140;
            lhs(6,0)=DN(1,0)*clhs4 + DN(1,1)*clhs69 + DN(1,2)*clhs104;
            lhs(6,1)=DN(1,0)*clhs10 + DN(1,1)*clhs72 + DN(1,2)*clhs105;
            lhs(6,2)=DN(1,0)*clhs15 + DN(1,1)*clhs75 + DN(1,2)*clhs106;
            lhs(6,3)=-clhs125;
            lhs(6,4)=DN(1,0)*clhs21 + DN(1,1)*clhs78 + DN(1,2)*clhs108;
            lhs(6,5)=DN(1,0)*clhs27 + DN(1,1)*clhs81 + DN(1,2)*clhs109;
            lhs(6,6)=DN(1,0)*clhs32 + DN(1,1)*clhs84 + DN(1,2)*clhs110;
            lhs(6,7)=-clhs141;
            lhs(6,8)=DN(1,0)*clhs38 + DN(1,1)*clhs87 + DN(1,2)*clhs112;
            lhs(6,9)=DN(1,0)*clhs44 + DN(1,1)*clhs90 + DN(1,2)*clhs113;
            lhs(6,10)=DN(1,0)*clhs49 + DN(1,1)*clhs93 + DN(1,2)*clhs114;
            lhs(6,11)=-clhs142;
            lhs(6,12)=DN(1,0)*clhs55 + DN(1,1)*clhs96 + DN(1,2)*clhs116;
            lhs(6,13)=DN(1,0)*clhs61 + DN(1,1)*clhs99 + DN(1,2)*clhs117;
            lhs(6,14)=DN(1,0)*clhs66 + DN(1,1)*clhs102 + DN(1,2)*clhs118;
            lhs(6,15)=-clhs143;
            lhs(7,0)=r[0]*(clhs120*clhs123 + clhs33*k);
            lhs(7,1)=r[0]*(clhs120*clhs124 + clhs85*k);
            lhs(7,2)=r[0]*(clhs111*k + clhs120*clhs125);
            lhs(7,3)=clhs126;
            lhs(7,4)=clhs135*clhs144;
            lhs(7,5)=clhs138*clhs144;
            lhs(7,6)=clhs141*clhs144;
            lhs(7,7)=tau1*(pow(DN(1,0), 2) + pow(DN(1,1), 2) + pow(DN(1,2), 2));
            lhs(7,8)=r[2]*(clhs120*clhs136 + clhs145*k);
            lhs(7,9)=r[2]*(clhs120*clhs139 + clhs146*k);
            lhs(7,10)=r[2]*(clhs120*clhs142 + clhs147*k);
            lhs(7,11)=clhs148;
            lhs(7,12)=r[3]*(clhs120*clhs137 + clhs149*k);
            lhs(7,13)=r[3]*(clhs120*clhs140 + clhs150*k);
            lhs(7,14)=r[3]*(clhs120*clhs143 + clhs151*k);
            lhs(7,15)=clhs152;
            lhs(8,0)=DN(2,0)*clhs0 + DN(2,1)*clhs2 + DN(2,2)*clhs4;
            lhs(8,1)=DN(2,0)*clhs5 + DN(2,1)*clhs7 + DN(2,2)*clhs10;
            lhs(8,2)=DN(2,0)*clhs11 + DN(2,1)*clhs13 + DN(2,2)*clhs15;
            lhs(8,3)=-clhs127;
            lhs(8,4)=DN(2,0)*clhs17 + DN(2,1)*clhs19 + DN(2,2)*clhs21;
            lhs(8,5)=DN(2,0)*clhs22 + DN(2,1)*clhs24 + DN(2,2)*clhs27;
            lhs(8,6)=DN(2,0)*clhs28 + DN(2,1)*clhs30 + DN(2,2)*clhs32;
            lhs(8,7)=-clhs145;
            lhs(8,8)=DN(2,0)*clhs34 + DN(2,1)*clhs36 + DN(2,2)*clhs38;
            lhs(8,9)=DN(2,0)*clhs39 + DN(2,1)*clhs41 + DN(2,2)*clhs44;
            lhs(8,10)=DN(2,0)*clhs45 + DN(2,1)*clhs47 + DN(2,2)*clhs49;
            lhs(8,11)=-clhs153;
            lhs(8,12)=DN(2,0)*clhs51 + DN(2,1)*clhs53 + DN(2,2)*clhs55;
            lhs(8,13)=DN(2,0)*clhs56 + DN(2,1)*clhs58 + DN(2,2)*clhs61;
            lhs(8,14)=DN(2,0)*clhs62 + DN(2,1)*clhs64 + DN(2,2)*clhs66;
            lhs(8,15)=-clhs154;
            lhs(9,0)=DN(2,0)*clhs2 + DN(2,1)*clhs68 + DN(2,2)*clhs69;
            lhs(9,1)=DN(2,0)*clhs7 + DN(2,1)*clhs70 + DN(2,2)*clhs72;
            lhs(9,2)=DN(2,0)*clhs13 + DN(2,1)*clhs73 + DN(2,2)*clhs75;
            lhs(9,3)=-clhs128;
            lhs(9,4)=DN(2,0)*clhs19 + DN(2,1)*clhs77 + DN(2,2)*clhs78;
            lhs(9,5)=DN(2,0)*clhs24 + DN(2,1)*clhs79 + DN(2,2)*clhs81;
            lhs(9,6)=DN(2,0)*clhs30 + DN(2,1)*clhs82 + DN(2,2)*clhs84;
            lhs(9,7)=-clhs146;
            lhs(9,8)=DN(2,0)*clhs36 + DN(2,1)*clhs86 + DN(2,2)*clhs87;
            lhs(9,9)=DN(2,0)*clhs41 + DN(2,1)*clhs88 + DN(2,2)*clhs90;
            lhs(9,10)=DN(2,0)*clhs47 + DN(2,1)*clhs91 + DN(2,2)*clhs93;
            lhs(9,11)=-clhs155;
            lhs(9,12)=DN(2,0)*clhs53 + DN(2,1)*clhs95 + DN(2,2)*clhs96;
            lhs(9,13)=DN(2,0)*clhs58 + DN(2,1)*clhs97 + DN(2,2)*clhs99;
            lhs(9,14)=DN(2,0)*clhs64 + DN(2,1)*clhs100 + DN(2,2)*clhs102;
            lhs(9,15)=-clhs156;
            lhs(10,0)=DN(2,0)*clhs4 + DN(2,1)*clhs69 + DN(2,2)*clhs104;
            lhs(10,1)=DN(2,0)*clhs10 + DN(2,1)*clhs72 + DN(2,2)*clhs105;
            lhs(10,2)=DN(2,0)*clhs15 + DN(2,1)*clhs75 + DN(2,2)*clhs106;
            lhs(10,3)=-clhs129;
            lhs(10,4)=DN(2,0)*clhs21 + DN(2,1)*clhs78 + DN(2,2)*clhs108;
            lhs(10,5)=DN(2,0)*clhs27 + DN(2,1)*clhs81 + DN(2,2)*clhs109;
            lhs(10,6)=DN(2,0)*clhs32 + DN(2,1)*clhs84 + DN(2,2)*clhs110;
            lhs(10,7)=-clhs147;
            lhs(10,8)=DN(2,0)*clhs38 + DN(2,1)*clhs87 + DN(2,2)*clhs112;
            lhs(10,9)=DN(2,0)*clhs44 + DN(2,1)*clhs90 + DN(2,2)*clhs113;
            lhs(10,10)=DN(2,0)*clhs49 + DN(2,1)*clhs93 + DN(2,2)*clhs114;
            lhs(10,11)=-clhs157;
            lhs(10,12)=DN(2,0)*clhs55 + DN(2,1)*clhs96 + DN(2,2)*clhs116;
            lhs(10,13)=DN(2,0)*clhs61 + DN(2,1)*clhs99 + DN(2,2)*clhs117;
            lhs(10,14)=DN(2,0)*clhs66 + DN(2,1)*clhs102 + DN(2,2)*clhs118;
            lhs(10,15)=-clhs158;
            lhs(11,0)=r[0]*(clhs120*clhs127 + clhs50*k);
            lhs(11,1)=r[0]*(clhs120*clhs128 + clhs94*k);
            lhs(11,2)=r[0]*(clhs115*k + clhs120*clhs129);
            lhs(11,3)=clhs130;
            lhs(11,4)=r[1]*(clhs120*clhs145 + clhs136*k);
            lhs(11,5)=r[1]*(clhs120*clhs146 + clhs139*k);
            lhs(11,6)=r[1]*(clhs120*clhs147 + clhs142*k);
            lhs(11,7)=clhs148;
            lhs(11,8)=clhs153*clhs159;
            lhs(11,9)=clhs155*clhs159;
            lhs(11,10)=clhs157*clhs159;
            lhs(11,11)=tau1*(pow(DN(2,0), 2) + pow(DN(2,1), 2) + pow(DN(2,2), 2));
            lhs(11,12)=r[3]*(clhs120*clhs154 + clhs160*k);
            lhs(11,13)=r[3]*(clhs120*clhs156 + clhs161*k);
            lhs(11,14)=r[3]*(clhs120*clhs158 + clhs162*k);
            lhs(11,15)=clhs163;
            lhs(12,0)=DN(3,0)*clhs0 + DN(3,1)*clhs2 + DN(3,2)*clhs4;
            lhs(12,1)=DN(3,0)*clhs5 + DN(3,1)*clhs7 + DN(3,2)*clhs10;
            lhs(12,2)=DN(3,0)*clhs11 + DN(3,1)*clhs13 + DN(3,2)*clhs15;
            lhs(12,3)=-clhs131;
            lhs(12,4)=DN(3,0)*clhs17 + DN(3,1)*clhs19 + DN(3,2)*clhs21;
            lhs(12,5)=DN(3,0)*clhs22 + DN(3,1)*clhs24 + DN(3,2)*clhs27;
            lhs(12,6)=DN(3,0)*clhs28 + DN(3,1)*clhs30 + DN(3,2)*clhs32;
            lhs(12,7)=-clhs149;
            lhs(12,8)=DN(3,0)*clhs34 + DN(3,1)*clhs36 + DN(3,2)*clhs38;
            lhs(12,9)=DN(3,0)*clhs39 + DN(3,1)*clhs41 + DN(3,2)*clhs44;
            lhs(12,10)=DN(3,0)*clhs45 + DN(3,1)*clhs47 + DN(3,2)*clhs49;
            lhs(12,11)=-clhs160;
            lhs(12,12)=DN(3,0)*clhs51 + DN(3,1)*clhs53 + DN(3,2)*clhs55;
            lhs(12,13)=DN(3,0)*clhs56 + DN(3,1)*clhs58 + DN(3,2)*clhs61;
            lhs(12,14)=DN(3,0)*clhs62 + DN(3,1)*clhs64 + DN(3,2)*clhs66;
            lhs(12,15)=-clhs164;
            lhs(13,0)=DN(3,0)*clhs2 + DN(3,1)*clhs68 + DN(3,2)*clhs69;
            lhs(13,1)=DN(3,0)*clhs7 + DN(3,1)*clhs70 + DN(3,2)*clhs72;
            lhs(13,2)=DN(3,0)*clhs13 + DN(3,1)*clhs73 + DN(3,2)*clhs75;
            lhs(13,3)=-clhs132;
            lhs(13,4)=DN(3,0)*clhs19 + DN(3,1)*clhs77 + DN(3,2)*clhs78;
            lhs(13,5)=DN(3,0)*clhs24 + DN(3,1)*clhs79 + DN(3,2)*clhs81;
            lhs(13,6)=DN(3,0)*clhs30 + DN(3,1)*clhs82 + DN(3,2)*clhs84;
            lhs(13,7)=-clhs150;
            lhs(13,8)=DN(3,0)*clhs36 + DN(3,1)*clhs86 + DN(3,2)*clhs87;
            lhs(13,9)=DN(3,0)*clhs41 + DN(3,1)*clhs88 + DN(3,2)*clhs90;
            lhs(13,10)=DN(3,0)*clhs47 + DN(3,1)*clhs91 + DN(3,2)*clhs93;
            lhs(13,11)=-clhs161;
            lhs(13,12)=DN(3,0)*clhs53 + DN(3,1)*clhs95 + DN(3,2)*clhs96;
            lhs(13,13)=DN(3,0)*clhs58 + DN(3,1)*clhs97 + DN(3,2)*clhs99;
            lhs(13,14)=DN(3,0)*clhs64 + DN(3,1)*clhs100 + DN(3,2)*clhs102;
            lhs(13,15)=-clhs165;
            lhs(14,0)=DN(3,0)*clhs4 + DN(3,1)*clhs69 + DN(3,2)*clhs104;
            lhs(14,1)=DN(3,0)*clhs10 + DN(3,1)*clhs72 + DN(3,2)*clhs105;
            lhs(14,2)=DN(3,0)*clhs15 + DN(3,1)*clhs75 + DN(3,2)*clhs106;
            lhs(14,3)=-clhs133;
            lhs(14,4)=DN(3,0)*clhs21 + DN(3,1)*clhs78 + DN(3,2)*clhs108;
            lhs(14,5)=DN(3,0)*clhs27 + DN(3,1)*clhs81 + DN(3,2)*clhs109;
            lhs(14,6)=DN(3,0)*clhs32 + DN(3,1)*clhs84 + DN(3,2)*clhs110;
            lhs(14,7)=-clhs151;
            lhs(14,8)=DN(3,0)*clhs38 + DN(3,1)*clhs87 + DN(3,2)*clhs112;
            lhs(14,9)=DN(3,0)*clhs44 + DN(3,1)*clhs90 + DN(3,2)*clhs113;
            lhs(14,10)=DN(3,0)*clhs49 + DN(3,1)*clhs93 + DN(3,2)*clhs114;
            lhs(14,11)=-clhs162;
            lhs(14,12)=DN(3,0)*clhs55 + DN(3,1)*clhs96 + DN(3,2)*clhs116;
            lhs(14,13)=DN(3,0)*clhs61 + DN(3,1)*clhs99 + DN(3,2)*clhs117;
            lhs(14,14)=DN(3,0)*clhs66 + DN(3,1)*clhs102 + DN(3,2)*clhs118;
            lhs(14,15)=-clhs166;
            lhs(15,0)=r[0]*(clhs120*clhs131 + clhs67*k);
            lhs(15,1)=r[0]*(clhs103*k + clhs120*clhs132);
            lhs(15,2)=r[0]*(clhs119*k + clhs120*clhs133);
            lhs(15,3)=clhs134;
            lhs(15,4)=r[1]*(clhs120*clhs149 + clhs137*k);
            lhs(15,5)=r[1]*(clhs120*clhs150 + clhs140*k);
            lhs(15,6)=r[1]*(clhs120*clhs151 + clhs143*k);
            lhs(15,7)=clhs152;
            lhs(15,8)=r[2]*(clhs120*clhs160 + clhs154*k);
            lhs(15,9)=r[2]*(clhs120*clhs161 + clhs156*k);
            lhs(15,10)=r[2]*(clhs120*clhs162 + clhs158*k);
            lhs(15,11)=clhs163;
            lhs(15,12)=clhs164*clhs167;
            lhs(15,13)=clhs165*clhs167;
            lhs(15,14)=clhs166*clhs167;
            lhs(15,15)=tau1*(pow(DN(3,0), 2) + pow(DN(3,1), 2) + pow(DN(3,2), 2));


    }

void Stokes3DWeaklyCompressible::ComputeGaussPointRHSContribution(array_1d<double,16>& rhs, const element_data<4,3>& data)
    {
        const int nnodes = 4;
        const int dim = 3;
        
        
        const double& bdf0 = data.bdf0;
        const double& bdf1 = data.bdf1;
        const double& bdf2 = data.bdf2;
        
        const bounded_matrix<double,nnodes,dim>& v = data.v;
        const bounded_matrix<double,nnodes,dim>& vn = data.vn;
        const bounded_matrix<double,nnodes,dim>& vnn = data.vnn;
        const bounded_matrix<double,nnodes,dim>& f = data.f;
        const auto& p = data.p;
        const auto& pn = data.pn;
        const auto& pnn = data.pnn;
        const auto& r = data.r;
        const auto& rn = data.rn;
        const auto& rnn = data.rnn; 
        
        const double rho_gauss = inner_prod(data.N, data.r);
        
        const double k = data.k;
        
        //get constitutive matrix 
        const Matrix& C = data.C;
        const Vector& stress = data.stress;
        
        //get shape function values
        const bounded_matrix<double,nnodes,dim>& DN = data.DN_DX;
        const array_1d<double,nnodes>& N = data.N;
        
        //compute an equivalent tau by Bitrans*c*Bi
        const double tau_denom =             (C(3,3) + C(4,4) + C(5,5))*(pow(DN(0,0), 2) + pow(DN(0,1), 2) + pow(DN(0,2), 2) + pow(DN(1,0), 2) + pow(DN(1,1), 2) + pow(DN(1,2), 2) + pow(DN(2,0), 2) + pow(DN(2,1), 2) + pow(DN(2,2), 2) + pow(DN(3,0), 2) + pow(DN(3,1), 2) + pow(DN(3,2), 2));

        const double tau1 = 1.0/(tau_denom*rho_gauss);
//         const double tau2 = (C(3,3) + C(4,4) + C(5,5))/(6.0*rho_gauss);
        
        

        const double crhs0 =             N[0]*p[0] + N[1]*p[1] + N[2]*p[2] + N[3]*p[3];
const double crhs1 =             N[0]*f(0,0);
const double crhs2 =             N[1]*f(1,0);
const double crhs3 =             N[2]*f(2,0);
const double crhs4 =             N[3]*f(3,0);
const double crhs5 =             crhs1 + crhs2 + crhs3 + crhs4;
const double crhs6 =             N[0]*f(0,1);
const double crhs7 =             N[1]*f(1,1);
const double crhs8 =             N[2]*f(2,1);
const double crhs9 =             N[3]*f(3,1);
const double crhs10 =             crhs6 + crhs7 + crhs8 + crhs9;
const double crhs11 =             N[0]*f(0,2);
const double crhs12 =             N[1]*f(1,2);
const double crhs13 =             N[2]*f(2,2);
const double crhs14 =             N[3]*f(3,2);
const double crhs15 =             crhs11 + crhs12 + crhs13 + crhs14;
const double crhs16 =             r[0]*v(0,0);
const double crhs17 =             r[0]*v(0,1);
const double crhs18 =             r[0]*v(0,2);
const double crhs19 =             r[1]*v(1,0);
const double crhs20 =             r[1]*v(1,1);
const double crhs21 =             r[1]*v(1,2);
const double crhs22 =             r[2]*v(2,0);
const double crhs23 =             r[2]*v(2,1);
const double crhs24 =             r[2]*v(2,2);
const double crhs25 =             r[3]*v(3,0);
const double crhs26 =             r[3]*v(3,1);
const double crhs27 =             r[3]*v(3,2);
const double crhs28 =             k*(DN(0,0)*crhs16 + DN(0,1)*crhs17 + DN(0,2)*crhs18 + DN(1,0)*crhs19 + DN(1,1)*crhs20 + DN(1,2)*crhs21 + DN(2,0)*crhs22 + DN(2,1)*crhs23 + DN(2,2)*crhs24 + DN(3,0)*crhs25 + DN(3,1)*crhs26 + DN(3,2)*crhs27);
const double crhs29 =             bdf1*rn[0];
const double crhs30 =             bdf2*rnn[0];
const double crhs31 =             bdf1*rn[1];
const double crhs32 =             bdf2*rnn[1];
const double crhs33 =             bdf1*rn[2];
const double crhs34 =             bdf2*rnn[2];
const double crhs35 =             bdf1*rn[3];
const double crhs36 =             bdf2*rnn[3];
const double crhs37 =             tau1*(DN(0,0)*p[0] + DN(1,0)*p[1] + DN(2,0)*p[2] + DN(3,0)*p[3] + N[0]*(bdf0*crhs16 + crhs29*vn(0,0) + crhs30*vnn(0,0)) + N[1]*(bdf0*crhs19 + crhs31*vn(1,0) + crhs32*vnn(1,0)) + N[2]*(bdf0*crhs22 + crhs33*vn(2,0) + crhs34*vnn(2,0)) + N[3]*(bdf0*crhs25 + crhs35*vn(3,0) + crhs36*vnn(3,0)) - crhs1 - crhs2 - crhs3 - crhs4);
const double crhs38 =             tau1*(DN(0,1)*p[0] + DN(1,1)*p[1] + DN(2,1)*p[2] + DN(3,1)*p[3] + N[0]*(bdf0*crhs17 + crhs29*vn(0,1) + crhs30*vnn(0,1)) + N[1]*(bdf0*crhs20 + crhs31*vn(1,1) + crhs32*vnn(1,1)) + N[2]*(bdf0*crhs23 + crhs33*vn(2,1) + crhs34*vnn(2,1)) + N[3]*(bdf0*crhs26 + crhs35*vn(3,1) + crhs36*vnn(3,1)) - crhs6 - crhs7 - crhs8 - crhs9);
const double crhs39 =             tau1*(DN(0,2)*p[0] + DN(1,2)*p[1] + DN(2,2)*p[2] + DN(3,2)*p[3] + N[0]*(bdf0*crhs18 + crhs29*vn(0,2) + crhs30*vnn(0,2)) + N[1]*(bdf0*crhs21 + crhs31*vn(1,2) + crhs32*vnn(1,2)) + N[2]*(bdf0*crhs24 + crhs33*vn(2,2) + crhs34*vnn(2,2)) + N[3]*(bdf0*crhs27 + crhs35*vn(3,2) + crhs36*vnn(3,2)) - crhs11 - crhs12 - crhs13 - crhs14);
            rhs[0]=DN(0,0)*crhs0 - DN(0,0)*stress[0] - DN(0,1)*stress[3] - DN(0,2)*stress[5] + N[0]*crhs5;
            rhs[1]=-DN(0,0)*stress[3] + DN(0,1)*crhs0 - DN(0,1)*stress[1] - DN(0,2)*stress[4] + N[0]*crhs10;
            rhs[2]=-DN(0,0)*stress[5] - DN(0,1)*stress[4] + DN(0,2)*crhs0 - DN(0,2)*stress[2] + N[0]*crhs15;
            rhs[3]=-DN(0,0)*crhs37 - DN(0,1)*crhs38 - DN(0,2)*crhs39 - N[0]*crhs28;
            rhs[4]=DN(1,0)*crhs0 - DN(1,0)*stress[0] - DN(1,1)*stress[3] - DN(1,2)*stress[5] + N[1]*crhs5;
            rhs[5]=-DN(1,0)*stress[3] + DN(1,1)*crhs0 - DN(1,1)*stress[1] - DN(1,2)*stress[4] + N[1]*crhs10;
            rhs[6]=-DN(1,0)*stress[5] - DN(1,1)*stress[4] + DN(1,2)*crhs0 - DN(1,2)*stress[2] + N[1]*crhs15;
            rhs[7]=-DN(1,0)*crhs37 - DN(1,1)*crhs38 - DN(1,2)*crhs39 - N[1]*crhs28;
            rhs[8]=DN(2,0)*crhs0 - DN(2,0)*stress[0] - DN(2,1)*stress[3] - DN(2,2)*stress[5] + N[2]*crhs5;
            rhs[9]=-DN(2,0)*stress[3] + DN(2,1)*crhs0 - DN(2,1)*stress[1] - DN(2,2)*stress[4] + N[2]*crhs10;
            rhs[10]=-DN(2,0)*stress[5] - DN(2,1)*stress[4] + DN(2,2)*crhs0 - DN(2,2)*stress[2] + N[2]*crhs15;
            rhs[11]=-DN(2,0)*crhs37 - DN(2,1)*crhs38 - DN(2,2)*crhs39 - N[2]*crhs28;
            rhs[12]=DN(3,0)*crhs0 - DN(3,0)*stress[0] - DN(3,1)*stress[3] - DN(3,2)*stress[5] + N[3]*crhs5;
            rhs[13]=-DN(3,0)*stress[3] + DN(3,1)*crhs0 - DN(3,1)*stress[1] - DN(3,2)*stress[4] + N[3]*crhs10;
            rhs[14]=-DN(3,0)*stress[5] - DN(3,1)*stress[4] + DN(3,2)*crhs0 - DN(3,2)*stress[2] + N[3]*crhs15;
            rhs[15]=-DN(3,0)*crhs37 - DN(3,1)*crhs38 - DN(3,2)*crhs39 - N[3]*crhs28;

        
    }
   
}
